'use strict';

var split2 = require('split2');
var collect = require('stream-collect');
var documentHasErrors = require('./documentHasErrors');

function streamToArray(stream) {
  var jsonStream = stream.pipe(getJsonStreamer());
  return collect(jsonStream);
}

function getJsonStreamer() {
  var lineNumber = 0;
  return split2(parseRow);

  function parseRow(row) {
    lineNumber++;

    if (!row) {
      return undefined;
    }

    try {
      var doc = JSON.parse(row);
      var error = documentHasErrors(doc);
      if (error) {
        throw new Error(error);
      }

      return doc;
    } catch (err) {
      this.emit('error', new Error(`Failed to parse line #${lineNumber}: ${err.message}`));
    }

    return undefined;
  }
}

module.exports = streamToArray;