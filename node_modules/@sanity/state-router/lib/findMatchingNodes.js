'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _pick2 = require('lodash/pick');

var _pick3 = _interopRequireDefault(_pick2);

var _intersection2 = require('lodash/intersection');

var _intersection3 = _interopRequireDefault(_intersection2);

var _difference2 = require('lodash/difference');

var _difference3 = _interopRequireDefault(_difference2);

exports.default = findMatchingRoutes;

var _arrayify = require('./utils/arrayify');

var _arrayify2 = _interopRequireDefault(_arrayify);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

/*:: import type {Node, MatchResult} from './types'*/


function createMatchResult(nodes /*: Node[]*/, missing /*: string[]*/, remaining /*: string[]*/) /*: MatchResult*/ {
  return { nodes: nodes, missing: missing, remaining: remaining };
}

function findMatchingRoutes(node /*: Node*/, _state /*: ?Object*/) /*: MatchResult*/ {

  if (_state === null || _state === undefined) {
    return createMatchResult([], [], []);
  }

  var state = node.scope ? _state[node.scope] : _state;

  var requiredParams = node.route.segments.filter(function (seg) {
    return seg.type === 'param';
  }).map(function (seg) {
    return seg.name;
  });

  var stateKeys = state ? Object.keys(state) : [];

  var consumedParams = (0, _intersection3.default)(stateKeys, requiredParams);
  var missingParams = (0, _difference3.default)(requiredParams, consumedParams);
  var remainingParams = (0, _difference3.default)(stateKeys, consumedParams);

  if (missingParams.length > 0) {
    return createMatchResult([], missingParams, []);
  }

  if (remainingParams.length === 0) {
    return createMatchResult([node], [], []);
  }

  var children = (typeof node.children === 'function' ? node.children(state) : node.children) || [];

  if (remainingParams.length > 0 && children.length === 0) {
    return createMatchResult([], remainingParams, []);
  }

  var remainingState = (0, _pick3.default)(state, remainingParams);

  var matchingChild /*: MatchResult*/ = { nodes: [], remaining: [], missing: [] };

  (0, _arrayify2.default)(children).some(function (childNode) {
    matchingChild = findMatchingRoutes(childNode, remainingState);
    return matchingChild.nodes.length > 0;
  });

  if (matchingChild.nodes.length === 0) {
    return createMatchResult([], missingParams, remainingParams);
  }

  return createMatchResult([node].concat(_toConsumableArray(matchingChild.nodes)), matchingChild.missing, matchingChild.remaining);
}